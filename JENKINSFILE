//JENKINSFILE CD

pipeline {
    
    agent any
    
    options {
        skipDefaultCheckout true
    }
    
    stages {
        stage('Get Code') {
            steps {
                deleteDir()
                git 'https://github.com/AntonioMLUnir/Practica1.4'
            }
        }
        
        stage('Deploy') {
            steps {
                sh '''
                    sam build
                    sam validate --region us-east-1
                    sam deploy --config-env production --no-confirm-changeset --resolve-s3 --no-fail-on-empty-changeset
                '''
            }
        }
        
        stage('Rest Test') {
            steps {
                 catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                     sh '''
                        set PYTHONPATH=.
                        
                        export BASE_URL=$(aws cloudformation describe-stacks \
                        --region us-east-1 \
                        --stack-name todo-list-aws-production \
                        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                        --output text)

                        pytest -s -v -m read_only --junitxml=rest_report_cd.xml test/integration/todoApiTest.py
                    '''
                    
                    junit 'rest_report_cd.xml'
                }
            }
        }
    }
}
