//JENKINSFILE CD

pipeline {
    agent any
    
    options {
        skipDefaultCheckout true
    }
    
    stages {
        
        stage('Get Code') {
            steps {
                deleteDir()
                git branch: 'develop', url: 'https://github.com/AntonioMLUnir/Practica1.4'
            }
        }
               
        stage('Static') {
            parallel {
                stage('Flake8') {
                    steps {
                        sh '''
                            set PYTHONPATH=%WORKSPACE%
                            python3 -m flake8 src/ --exit-zero --format=pylint --output-file=flake8_report.txt
                        '''
                    }
                }
                
                stage('Seguridad') {
                    steps {
                        sh '''
                            set PYTHONPATH=%WORKSPACE%
                            bandit -r src/ -f txt -o bandit_report.txt
                        '''
                    }
                }
            }
            
            post {
                always {
                    archiveArtifacts artifacts: 'flake8_report.txt, bandit_report.txt', followSymlinks: false
                }
            }
        }
        
        stage('Deploy') {
            steps {
                sh '''
                    sam build
                    sam validate --region us-east-1
                    sam deploy --config-env staging --no-confirm-changeset --resolve-s3 --no-fail-on-empty-changeset
                '''
            }
        }
        
        stage('Rest Test') {
            steps {
                 catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                     sh '''
                        set PYTHONPATH=.
                        
                        export BASE_URL=$(aws cloudformation describe-stacks \
                        --region us-east-1 \
                        --stack-name staging-todo-list-aws \
                        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                        --output text)

                        pytest -s -v --junitxml=rest_report.xml test/integration/todoApiTest.py
                    '''
                    
                    junit 'rest_report.xml'
                }
            }
        }
        
        stage('Promoci√≥n') {
            
            when {
                expression { currentBuild.result == 'SUCCESS' || currentBuild.result == null }
            }

            steps {
                withCredentials([usernamePassword(credentialsId:'Jenkins-GitHub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh '''
                        git remote set-url origin https://${USER}:${PASS}@github.com/AntonioMLUnir/Practica1.4.git
                        
                        git fetch origin
                        git checkout master
                        git merge origin/develop
                        
                        git push origin master
                    '''
                }
            }
        }
    }
}